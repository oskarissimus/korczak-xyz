---
import Navbar from '../components/Navbar/Navbar.astro';
import Footer from '../components/Footer.astro';
import type { Lang } from '../i18n';

interface Props {
  title?: string;
  description?: string;
  lang?: Lang;
}

const {
  title = 'korczak.xyz',
  description = 'Personal website of Oskar Korczak',
  lang = 'en'
} = Astro.props;

const currentPath = Astro.url.pathname;
---

<!DOCTYPE html>
<html lang={lang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content={description} />
    <meta name="image" content="https://korczak.xyz/logo.png" />
    <link rel="icon" href="/favicon-32x32.png" type="image/png" />
    <title>{title}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Press+Start+2P&display=swap" rel="stylesheet">
  </head>
  <body>
    <!-- SVG filter for Win95 dithered 16-color effect -->
    <svg style="position: absolute; width: 0; height: 0;">
      <defs>
        <!-- Dither pattern -->
        <filter id="dither-pattern" x="0" y="0" width="100%" height="100%">
          <feTurbulence type="fractalNoise" baseFrequency="1.5" numOctaves="1" result="noise"/>
          <feComponentTransfer result="threshold">
            <feFuncR type="discrete" tableValues="0 1"/>
            <feFuncG type="discrete" tableValues="0 1"/>
            <feFuncB type="discrete" tableValues="0 1"/>
          </feComponentTransfer>
        </filter>

        <!-- Combined dither + posterize filter -->
        <filter id="win95-dithered" x="0" y="0" width="100%" height="100%">
          <!-- Add noise before posterizing to create dither effect -->
          <feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="1" result="noise"/>
          <feDisplacementMap in="SourceGraphic" in2="noise" scale="2" xChannelSelector="R" yChannelSelector="G" result="displaced"/>

          <!-- Blend noise with image for dithering -->
          <feBlend in="SourceGraphic" in2="noise" mode="overlay" result="dithered"/>

          <!-- Posterize to 64 colors (4 levels per channel = 4x4x4 = 64) -->
          <feComponentTransfer in="dithered">
            <feFuncR type="discrete" tableValues="0 0.33 0.67 1"/>
            <feFuncG type="discrete" tableValues="0 0.33 0.67 1"/>
            <feFuncB type="discrete" tableValues="0 0.33 0.67 1"/>
          </feComponentTransfer>

          <!-- Boost contrast -->
          <feComponentTransfer>
            <feFuncR type="linear" slope="1.15" intercept="-0.075"/>
            <feFuncG type="linear" slope="1.15" intercept="-0.075"/>
            <feFuncB type="linear" slope="1.15" intercept="-0.075"/>
          </feComponentTransfer>
        </filter>
      </defs>
    </svg>
    <div class="container">
      <Navbar lang={lang} currentPath={currentPath} />
      <slot />
      <Footer lang={lang} />
    </div>
  </body>
</html>

<style is:global>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  :root {
    --retro-navy: #000080;
    --retro-teal: #008080;
    --retro-yellow: #ffff00;
    --retro-cyan: #00ffff;
    --retro-magenta: #ff00ff;
    --retro-gray: #c0c0c0;
    --retro-dark-gray: #808080;
    --retro-white: #ffffff;
    --retro-black: #000000;
    --retro-green: #00ff00;
    --retro-red: #ff0000;
  }

  body {
    font-family: 'VT323', monospace;
    min-height: 100vh;
    background: var(--retro-navy);
    color: var(--retro-yellow);
    padding: 20px;
    padding-bottom: 60px;
    font-size: 1.25rem;
    line-height: 1.4;
  }

  .container {
    max-width: 900px;
    margin: 0 auto;
  }

  /* Window styling */
  .window {
    background: var(--retro-gray);
    border: 3px outset var(--retro-white);
    margin-bottom: 20px;
    position: relative;
  }

  .window.dragging {
    opacity: 0.95;
  }

  .title-bar {
    background: linear-gradient(90deg, var(--retro-navy), #1084d0);
    color: white;
    padding: 4px 8px;
    font-family: 'Press Start 2P', cursive;
    font-size: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: grab;
    user-select: none;
  }

  .title-bar:active {
    cursor: grabbing;
  }

  .title-buttons {
    display: flex;
    gap: 4px;
  }

  .title-btn {
    width: 16px;
    height: 16px;
    background: var(--retro-gray);
    border: 2px outset var(--retro-white);
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: var(--retro-black);
  }

  .title-btn:hover {
    background: #a0a0a0;
  }

  .title-btn:active {
    border-style: inset;
  }

  .window-content {
    padding: 20px;
    background: var(--retro-teal);
    color: var(--retro-white);
  }

  /* Links */
  a {
    color: var(--retro-cyan);
    text-decoration: underline;
  }

  a:hover {
    color: var(--retro-yellow);
  }

  a:visited {
    color: var(--retro-magenta);
  }

  /* Retro buttons */
  .retro-btn {
    background: var(--retro-gray);
    border: 3px outset var(--retro-white);
    padding: 10px 20px;
    font-family: 'VT323', monospace;
    font-size: 1.2rem;
    color: var(--retro-black);
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
  }

  .retro-btn:hover {
    background: #a0a0a0;
    color: var(--retro-black);
  }

  .retro-btn:active {
    border-style: inset;
  }

  /* Animations */
  @keyframes rainbow {
    0% { color: #ff0000; }
    16% { color: #ff8800; }
    33% { color: #ffff00; }
    50% { color: #00ff00; }
    66% { color: #0088ff; }
    83% { color: #ff00ff; }
    100% { color: #ff0000; }
  }

  @keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
  }

  @keyframes marquee {
    0% { transform: translateX(100%); }
    100% { transform: translateX(-100%); }
  }

  .rainbow-text {
    animation: rainbow 3s infinite;
  }

  .blink {
    animation: blink 1s infinite;
  }

  /* Visitor counter style */
  .visitor-counter {
    background: var(--retro-black);
    display: inline-block;
    padding: 5px 15px;
    border: 2px inset var(--retro-dark-gray);
  }

  .visitor-counter span {
    font-family: 'VT323', monospace;
    color: var(--retro-green);
    font-size: 1.2rem;
  }

  /* Marquee */
  .marquee-container {
    background: var(--retro-black);
    padding: 10px;
    overflow: hidden;
    border: 2px inset var(--retro-dark-gray);
  }

  .marquee-text {
    white-space: nowrap;
    animation: marquee 15s linear infinite;
    color: var(--retro-green);
    font-size: 1.3rem;
  }

  /* Under construction */
  .under-construction {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-top: 20px;
    flex-wrap: wrap;
  }

  .construction-gif {
    width: 40px;
    height: 40px;
    background: repeating-linear-gradient(
      45deg,
      var(--retro-yellow),
      var(--retro-yellow) 10px,
      var(--retro-black) 10px,
      var(--retro-black) 20px
    );
    animation: spin 2s linear infinite;
  }

  @keyframes spin {
    100% { transform: rotate(360deg); }
  }

  /* Images - Win95 16-color style with dithering */
  img {
    max-width: 100%;
    height: auto;
    border: none;
    image-rendering: pixelated;
    filter: url(#win95-dithered);
  }

  /* Lists */
  ul, ol {
    margin-left: 20px;
    margin-bottom: 15px;
  }

  li {
    margin-bottom: 5px;
  }

  /* Headings */
  h1, h2, h3, h4, h5, h6 {
    font-family: 'Press Start 2P', cursive;
    margin-bottom: 15px;
    line-height: 1.5;
  }

  h1 {
    font-size: clamp(0.8rem, 3vw, 1.2rem);
    color: var(--retro-yellow);
    text-shadow: 3px 3px var(--retro-magenta);
  }

  h2 {
    font-size: clamp(0.7rem, 2.5vw, 1rem);
    color: var(--retro-cyan);
  }

  h3 {
    font-size: clamp(0.6rem, 2vw, 0.9rem);
    color: var(--retro-green);
  }

  /* Paragraphs */
  p {
    margin-bottom: 15px;
  }

  /* Code */
  code {
    background: var(--retro-black);
    color: var(--retro-green);
    padding: 2px 6px;
    font-family: 'VT323', monospace;
    border: 1px inset var(--retro-dark-gray);
  }

  pre {
    background: var(--retro-black);
    color: var(--retro-green);
    padding: 15px;
    overflow-x: auto;
    border: 2px inset var(--retro-dark-gray);
    margin-bottom: 15px;
  }

  pre code {
    border: none;
    padding: 0;
  }

  /* Form elements */
  input, textarea, select {
    font-family: 'VT323', monospace;
    font-size: 1.1rem;
    background: var(--retro-white);
    border: 2px inset var(--retro-dark-gray);
    padding: 8px;
    color: var(--retro-black);
  }

  input:focus, textarea:focus, select:focus {
    outline: 2px solid var(--retro-cyan);
  }

  button {
    font-family: 'VT323', monospace;
    font-size: 1.1rem;
    background: var(--retro-gray);
    border: 3px outset var(--retro-white);
    padding: 8px 16px;
    cursor: pointer;
    color: var(--retro-black);
  }

  button:hover {
    background: #a0a0a0;
  }

  button:active {
    border-style: inset;
  }

  /* Responsive */
  @media (max-width: 600px) {
    body {
      padding: 10px;
      font-size: 1.1rem;
    }

    .window-content {
      padding: 15px;
    }

    h1 {
      font-size: 0.7rem;
    }
  }
</style>

<script>
  // Close button functionality
  document.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    if (target.classList.contains('close-btn')) {
      const window = target.closest('.window');
      if (window) {
        (window as HTMLElement).style.display = 'none';
      }
    }
  });

  // Draggable windows
  let draggedWindow: HTMLElement | null = null;
  let startX = 0;
  let startY = 0;
  let currentTranslateX = 0;
  let currentTranslateY = 0;
  let highestZIndex = 100;

  function getTranslateValues(element: HTMLElement) {
    const transform = element.style.transform;
    if (!transform || transform === 'none') {
      return { x: 0, y: 0 };
    }
    const match = transform.match(/translate\((-?\d+(?:\.\d+)?px),\s*(-?\d+(?:\.\d+)?px)\)/);
    if (match) {
      return { x: parseFloat(match[1]), y: parseFloat(match[2]) };
    }
    return { x: 0, y: 0 };
  }

  function bringToFront(win: HTMLElement) {
    highestZIndex++;
    win.style.zIndex = String(highestZIndex);
  }

  document.addEventListener('mousedown', (e) => {
    const target = e.target as HTMLElement;

    // Only start drag if clicking on title-bar (not buttons)
    if (target.classList.contains('title-bar') ||
        (target.closest('.title-bar') && !target.closest('.title-buttons'))) {
      const titleBar = target.classList.contains('title-bar') ? target : target.closest('.title-bar');
      const win = titleBar?.closest('.window') as HTMLElement;

      if (win) {
        draggedWindow = win;
        draggedWindow.classList.add('dragging');
        bringToFront(win);

        const translate = getTranslateValues(win);
        currentTranslateX = translate.x;
        currentTranslateY = translate.y;
        startX = e.clientX;
        startY = e.clientY;

        e.preventDefault();
      }
    }
  });

  document.addEventListener('mousemove', (e) => {
    if (draggedWindow) {
      const deltaX = e.clientX - startX;
      const deltaY = e.clientY - startY;

      draggedWindow.style.transform = `translate(${currentTranslateX + deltaX}px, ${currentTranslateY + deltaY}px)`;
    }
  });

  document.addEventListener('mouseup', () => {
    if (draggedWindow) {
      draggedWindow.classList.remove('dragging');
      draggedWindow = null;
    }
  });
</script>
