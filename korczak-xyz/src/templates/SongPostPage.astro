---
import { getCollection, render } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import PageContent from '../components/PageContent.astro';
import '../styles/song.css';
import { type Lang, useTranslations } from '../i18n';

interface Props {
  lang: Lang;
  slug: string;
}

const { lang, slug } = Astro.props;
const t = useTranslations(lang);

// Songs are only in Polish collection
const songs = await getCollection('songs', ({ data }) =>
  data.published && data.language === 'pl' && data.slug === slug
);

if (songs.length === 0) {
  return Astro.redirect('/404');
}

const song = songs[0];
const { Content } = await render(song);

function formatDate(date: Date, locale: string): string {
  const localeMap: Record<string, string> = {
    'en': 'en-US',
    'pl': 'pl-PL'
  };
  return date.toLocaleDateString(localeMap[locale] || locale);
}
---

<Layout title={`${song.data.title} | korczak.xyz`} lang={lang}>
  <div class="song-page">
    <div class="window song-header-window">
      <div class="song-header-bar">
        <div class="title-bar song-title-bar">
          <span class="song-title-text">{song.data.title}</span>
          <div class="title-buttons">
            <div class="title-btn minimize-btn"></div>
            <div class="title-btn maximize-btn"></div>
            <div class="title-btn close-btn"></div>
          </div>
        </div>
        <div class="song-controls">
          <div class="song-meta">
            <span class="song-author">[{song.data.author}]</span>
            <span class="song-date">{t('Date added')}: {formatDate(song.data.dateAdded, lang)}</span>
          </div>
          <div class="song-controls-buttons" data-chords-label={t('song.chords')} data-text-label={t('song.text')} data-light-label={t('song.light')} data-dark-label={t('song.dark')} data-layout-side-label={t('song.layoutSide')} data-layout-top-label={t('song.layoutTop')} data-scroll-label={t('song.scroll')} data-scroll-pause-label={t('song.scrollPause')} data-video-label={t('song.video')} data-video-hide-label={t('song.videoHide')}>
            <div class="song-controls-row">
              <button class="chords-toggle" title="Toggle chords"><span class="btn-icon">â™ª</span><span class="btn-label">{t('song.chords')}</span></button>
              <button class="layout-toggle" title="Toggle chord layout"><span class="btn-icon">â«¶</span><span class="btn-label">{t('song.layoutSide')}</span></button>
              <span class="transpose-controls">
                <span class="control-label">{t('song.transpose')}</span>
                <button class="transpose-down" title="Transpose down">â™­</button>
                <span class="transpose-value">0</span>
                <button class="transpose-up" title="Transpose up">â™¯</button>
              </span>
            </div>
            <div class="song-controls-row">
              <button class="light-mode-toggle" title="Toggle light mode"><span class="btn-icon">â˜€</span><span class="btn-label">{t('song.light')}</span></button>
              <span class="font-controls">
                <span class="control-label">{t('song.font')}</span>
                <button class="font-decrease" title="Decrease font size">A-</button>
                <button class="font-increase" title="Increase font size">A+</button>
              </span>
              <span class="column-controls">
                <span class="control-label">{t('song.columns')}</span>
                <button class="column-decrease" title="Fewer columns">â—€ï¸Ž</button>
                <span class="column-count">1</span>
                <button class="column-increase" title="More columns">â–¶ï¸Ž</button>
              </span>
            </div>
            <div class="song-controls-row">
              <button class="autoscroll-toggle" title="Start/stop autoscroll">
                <span class="btn-icon">â–¶ï¸Ž</span>
                <span class="btn-label">{t('song.scroll')}</span>
              </button>
              <span class="autoscroll-controls">
                <span class="control-label">{t('song.speed')}</span>
                <button class="autoscroll-slower" title="Slower">â—€ï¸Ž</button>
                <span class="autoscroll-speed">3</span>
                <button class="autoscroll-faster" title="Faster">â–¶ï¸Ž</button>
              </span>
              <button class="video-toggle" title="Toggle video">
                <span class="btn-icon">ðŸ“º</span>
                <span class="btn-label">{t('song.video')}</span>
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="window-content song-content-wrapper">
        <section class="blog_post" id="song-content" itemprop="articleBody">
          <Content />
        </section>
      </div>
    </div>
    <div class="window song-window song-desktop-only">
      <div class="title-bar">
        <span>{song.data.title}</span>
        <div class="title-buttons">
          <div class="title-btn minimize-btn"></div>
          <div class="title-btn maximize-btn"></div>
          <div class="title-btn close-btn"></div>
        </div>
      </div>
      <div class="song-controls song-controls-desktop">
        <div class="song-meta">
          <span class="song-author">[{song.data.author}]</span>
          <span class="song-date">{t('Date added')}: {formatDate(song.data.dateAdded, lang)}</span>
        </div>
        <div class="song-controls-buttons" data-chords-label={t('song.chords')} data-text-label={t('song.text')} data-light-label={t('song.light')} data-dark-label={t('song.dark')} data-layout-side-label={t('song.layoutSide')} data-layout-top-label={t('song.layoutTop')} data-scroll-label={t('song.scroll')} data-scroll-pause-label={t('song.scrollPause')} data-video-label={t('song.video')} data-video-hide-label={t('song.videoHide')}>
          <div class="song-controls-row">
            <button class="chords-toggle" title="Toggle chords"><span class="btn-icon">â™ª</span><span class="btn-label">{t('song.chords')}</span></button>
            <button class="layout-toggle" title="Toggle chord layout"><span class="btn-icon">â«¶</span><span class="btn-label">{t('song.layoutSide')}</span></button>
            <span class="transpose-controls">
              <span class="control-label">{t('song.transpose')}</span>
              <button class="transpose-down" title="Transpose down">â™­</button>
              <span class="transpose-value">0</span>
              <button class="transpose-up" title="Transpose up">â™¯</button>
            </span>
          </div>
          <div class="song-controls-row">
            <button class="light-mode-toggle" title="Toggle light mode"><span class="btn-icon">â˜€</span><span class="btn-label">{t('song.light')}</span></button>
            <span class="font-controls">
              <span class="control-label">{t('song.font')}</span>
              <button class="font-decrease" title="Decrease font size">A-</button>
              <button class="font-increase" title="Increase font size">A+</button>
            </span>
            <span class="column-controls">
              <span class="control-label">{t('song.columns')}</span>
              <button class="column-decrease" title="Fewer columns">â—€ï¸Ž</button>
              <span class="column-count">1</span>
              <button class="column-increase" title="More columns">â–¶ï¸Ž</button>
            </span>
          </div>
          <div class="song-controls-row">
            <button class="autoscroll-toggle" title="Start/stop autoscroll">
              <span class="btn-icon">â–¶ï¸Ž</span>
              <span class="btn-label">{t('song.scroll')}</span>
            </button>
            <span class="autoscroll-controls">
              <span class="control-label">{t('song.speed')}</span>
              <button class="autoscroll-slower" title="Slower">â—€ï¸Ž</button>
              <span class="autoscroll-speed">3</span>
              <button class="autoscroll-faster" title="Faster">â–¶ï¸Ž</button>
            </span>
            <button class="video-toggle" title="Toggle video">
              <span class="btn-icon">ðŸ“º</span>
              <span class="btn-label">{t('song.video')}</span>
            </button>
          </div>
        </div>
      </div>
      <div class="window-content song-content-wrapper">
        <section class="blog_post" id="song-content-desktop" itemprop="articleBody">
          <Content />
        </section>
      </div>
    </div>
  </div>
</Layout>

<script>
  const contentMobile = document.getElementById('song-content');
  const contentDesktop = document.getElementById('song-content-desktop');
  const decreaseBtns = document.querySelectorAll('.font-decrease');
  const increaseBtns = document.querySelectorAll('.font-increase');
  const lightModeBtns = document.querySelectorAll('.light-mode-toggle');
  const chordsBtns = document.querySelectorAll('.chords-toggle');
  const layoutToggleBtns = document.querySelectorAll('.layout-toggle');
  const columnDecreaseBtns = document.querySelectorAll('.column-decrease');
  const columnIncreaseBtns = document.querySelectorAll('.column-increase');
  const columnCountDisplays = document.querySelectorAll('.column-count');
  const transposeDownBtns = document.querySelectorAll('.transpose-down');
  const transposeUpBtns = document.querySelectorAll('.transpose-up');
  const transposeValueDisplays = document.querySelectorAll('.transpose-value');
  const autoscrollToggleBtns = document.querySelectorAll('.autoscroll-toggle');
  const autoscrollSlowerBtns = document.querySelectorAll('.autoscroll-slower');
  const autoscrollFasterBtns = document.querySelectorAll('.autoscroll-faster');
  const autoscrollSpeedDisplays = document.querySelectorAll('.autoscroll-speed');
  const videoToggleBtns = document.querySelectorAll('.video-toggle');

  const FONT_SIZES = [1.0, 1.2, 1.4, 1.6, 1.8, 2.0, 2.4];
  const COLUMNS = [1, 2, 3, 4];
  const SCROLL_SPEEDS = [0.025, 0.05, 0.1, 0.2, 0.4]; // pixels per frame
  const STORAGE_KEY = 'song-font-size-index';
  const LIGHT_MODE_KEY = 'song-light-mode';
  const CHORDS_KEY = 'song-show-chords';
  const COLUMNS_KEY = 'song-columns';
  const TRANSPOSE_KEY = 'song-transpose';
  const LAYOUT_KEY = 'song-chord-layout';
  const AUTOSCROLL_KEY = 'song-autoscroll-speed';
  const VIDEO_KEY = 'song-show-video';

  // German notation chromatic scale: H = B natural, B = Bb
  const CHROMATIC = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'B', 'H'];

  let currentIndex = parseInt(localStorage.getItem(STORAGE_KEY) || '2', 10);
  let lightMode = localStorage.getItem(LIGHT_MODE_KEY) === 'true';
  let showChords = localStorage.getItem(CHORDS_KEY) !== 'false';
  let currentColumnIndex = parseInt(localStorage.getItem(COLUMNS_KEY) || '0', 10);
  let transposeValue = parseInt(localStorage.getItem(TRANSPOSE_KEY) || '0', 10);
  let sideLayout = localStorage.getItem(LAYOUT_KEY) === 'true';
  let autoscrollSpeedIndex = parseInt(localStorage.getItem(AUTOSCROLL_KEY) || '2', 10);
  let isAutoscrolling = false;
  let autoscrollAnimationId: number | null = null;
  let accumulatedScroll = 0;
  let showVideo = localStorage.getItem(VIDEO_KEY) !== 'false';

  function applyFontSize() {
    [contentMobile, contentDesktop].forEach(content => {
      if (content) {
        const size = FONT_SIZES[currentIndex];
        content.style.fontSize = `${size}rem`;
        const codeElements = content.querySelectorAll('pre code');
        codeElements.forEach((el) => {
          (el as HTMLElement).style.fontSize = `${size}rem`;
        });
      }
    });
  }

  function applyLightMode() {
    [contentMobile, contentDesktop].forEach(content => {
      if (content) {
        content.classList.toggle('light-mode', lightMode);
      }
    });
    lightModeBtns.forEach(btn => {
      const icon = btn.querySelector('.btn-icon');
      const label = btn.querySelector('.btn-label');
      const container = btn.closest('.song-controls-buttons');
      const lightLabel = container?.getAttribute('data-light-label') || 'Light';
      const darkLabel = container?.getAttribute('data-dark-label') || 'Dark';
      if (icon) icon.textContent = lightMode ? 'â˜¾' : 'â˜€';
      if (label) label.textContent = lightMode ? darkLabel : lightLabel;
    });
  }

  function saveFontSize() {
    localStorage.setItem(STORAGE_KEY, String(currentIndex));
  }

  function saveLightMode() {
    localStorage.setItem(LIGHT_MODE_KEY, String(lightMode));
  }

  function isChordLine(line: string): boolean {
    if (line.trim() === '') return false;
    // Chord pattern: optional whitespace, then chord symbols separated by spaces
    // Chords: A-H (or a-h for minor), optionally followed by #/b or German notation (is/es), then modifiers like m, 7, maj7, sus4, etc.
    // German notation: "is" = sharp (fis = F#, cis = C#), "es" = flat (es = Eb, as = Ab)
    const chordPattern = /^[A-Ha-h]([#b]|is|es)?(m|maj|min|dim|aug|sus|add|7|9|11|13|6|4|2)*$/;
    const tokens = line.trim().split(/\s+/);
    // A line is a chord line if all non-empty tokens match the chord pattern
    // and there's at least one token
    if (tokens.length === 0) return false;
    return tokens.every(token => {
      if (token === '') return true;
      // Also match verse numbers like "1." or "Ref." at start of lyrics
      if (/^\d+\.$/.test(token) || /^Ref\.?:?$/.test(token)) return false;
      return chordPattern.test(token);
    });
  }

  function transposeChord(chord: string, semitones: number): string {
    if (semitones === 0) return chord;

    // Match: root note (A-H), optional accidental (#/b or German is/es), and modifiers
    const match = chord.match(/^([A-Ha-h])([#b]|is|es)?(.*)$/);
    if (!match) return chord;

    const [, root, accidental, modifiers] = match;
    const isLowerCase = root === root.toLowerCase();
    const upperRoot = root.toUpperCase();

    // Find the base note index
    let noteIndex = CHROMATIC.indexOf(upperRoot);
    if (noteIndex === -1) return chord;

    // Apply accidental (including German notation: is = sharp, es = flat)
    if (accidental === '#' || accidental === 'is') {
      noteIndex = (noteIndex + 1) % 12;
    } else if (accidental === 'b' || accidental === 'es') {
      noteIndex = (noteIndex - 1 + 12) % 12;
    }

    // Transpose
    noteIndex = (noteIndex + semitones % 12 + 12) % 12;

    // Get the new note
    let newNote = CHROMATIC[noteIndex];

    // Preserve case for minor chord indication
    if (isLowerCase) {
      newNote = newNote.toLowerCase();
    }

    return newNote + modifiers;
  }

  function transposeLine(line: string, semitones: number): string {
    if (!isChordLine(line) || semitones === 0) return line;

    // Transpose each chord while preserving spacing (including German is/es notation)
    return line.replace(/([A-Ha-h](?:[#b]|is|es)?(?:m|maj|min|dim|aug|sus|add|7|9|11|13|6|4|2)*)/g,
      (match) => transposeChord(match, semitones)
    );
  }

  function escapeHtml(text: string): string {
    return text
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  function extractChordsFromLine(line: string): string {
    // Extract chord names from a chord line, removing positioning spaces
    const tokens = line.trim().split(/\s+/).filter(t => t !== '');
    return tokens.join(' ');
  }

  function renderSideLayout(lines: string[]): string {
    const rows: string[] = [];
    let i = 0;

    while (i < lines.length) {
      const line = lines[i];

      if (isChordLine(line)) {
        // Get the transposed chords
        const transposedLine = transposeLine(line, transposeValue);
        const chords = extractChordsFromLine(transposedLine);
        i++;

        // Check if next line is empty or also a chord line (intro/interlude)
        const nextLine = i < lines.length ? lines[i] : '';
        const isStandaloneChords = nextLine.trim() === '' || isChordLine(nextLine);

        if (isStandaloneChords) {
          // Render chord-only line with chords in the chord column (right-aligned)
          rows.push(`<span class="side-row chord-only"><span class="lyrics-text"></span><span class="chord-col">${escapeHtml(chords)}</span></span>`);
          // Skip the empty line if present
          if (i < lines.length && lines[i].trim() === '') {
            i++;
          }
        } else {
          // Normal: chord + lyrics side by side
          const lyrics = lines[i].trimEnd();
          i++;
          rows.push(`<span class="side-row"><span class="lyrics-text">${escapeHtml(lyrics)}</span><span class="chord-col">${escapeHtml(chords)}</span></span>`);
        }
      } else {
        // Non-chord line (lyrics without chords, or empty line)
        const text = line.trimEnd();
        if (text === '') {
          rows.push(`<span class="side-row"><span class="lyrics-text">&nbsp;</span><span class="chord-col"></span></span>`);
        } else {
          rows.push(`<span class="side-row"><span class="lyrics-text">${escapeHtml(text)}</span><span class="chord-col"></span></span>`);
        }
        i++;
      }
    }

    return rows.join('\n');
  }

  function groupChordAndLyrics(lines: string[]): string[] {
    const groups: string[] = [];
    let i = 0;

    while (i < lines.length) {
      const line = lines[i];

      if (isChordLine(line)) {
        // Start a group with this chord line
        let group = line;
        i++;
        // Include the next non-empty, non-chord line (the lyrics)
        if (i < lines.length && !isChordLine(lines[i]) && lines[i].trim() !== '') {
          group += '\n' + lines[i];
          i++;
        }
        groups.push(group);
      } else {
        // Non-chord line (lyrics without chords, or empty line)
        groups.push(line);
        i++;
      }
    }

    return groups;
  }

  // Store original content for each code element
  const originalContent = new Map<Element, string>();

  function storeOriginalContent() {
    [contentMobile, contentDesktop].forEach(content => {
      if (!content) return;
      const codeElements = content.querySelectorAll('pre code');
      codeElements.forEach(codeEl => {
        if (!originalContent.has(codeEl)) {
          originalContent.set(codeEl, codeEl.textContent || '');
        }
      });
    });
  }

  function applyChordVisibility() {
    [contentMobile, contentDesktop].forEach(content => {
      if (!content) return;

      // Toggle side layout class
      content.classList.toggle('side-chord-layout', sideLayout && showChords);

      const codeElements = content.querySelectorAll('pre code');
      codeElements.forEach(codeEl => {
        const original = originalContent.get(codeEl);
        if (!original) return;

        const lines = original.split('\n');

        if (sideLayout && showChords) {
          // Use side layout rendering
          codeEl.innerHTML = renderSideLayout(lines);
        } else if (showChords) {
          // Transpose chord lines
          const processedLines = lines.map(line => transposeLine(line, transposeValue));

          // Helper function to render a group with chord lines highlighted
          function renderGroup(group: string): string {
            const groupLines = group.split('\n');
            return groupLines.map(line => {
              if (isChordLine(line)) {
                return `<span class="chord-line">${escapeHtml(line)}</span>`;
              }
              // Handle empty lines with visible spacing
              if (line.trim() === '') {
                return `<span class="empty-line">&nbsp;</span>`;
              }
              return escapeHtml(line);
            }).join('\n');
          }

          // Group chord+lyrics pairs and wrap in spans to prevent column breaks
          const groups = groupChordAndLyrics(processedLines);
          codeEl.innerHTML = groups.map(group =>
            `<span class="lyrics-group">${renderGroup(group)}</span>`
          ).join('\n');
        } else {
          // Filter out chord lines (no need to transpose if hidden)
          const processedLines = lines.filter(line => !isChordLine(line));

          // Helper function to render a group with chord lines highlighted
          function renderGroup(group: string): string {
            const groupLines = group.split('\n');
            return groupLines.map(line => {
              if (isChordLine(line)) {
                return `<span class="chord-line">${escapeHtml(line)}</span>`;
              }
              // Handle empty lines with visible spacing
              if (line.trim() === '') {
                return `<span class="empty-line">&nbsp;</span>`;
              }
              return escapeHtml(line);
            }).join('\n');
          }

          // Group chord+lyrics pairs and wrap in spans to prevent column breaks
          const groups = groupChordAndLyrics(processedLines);
          codeEl.innerHTML = groups.map(group =>
            `<span class="lyrics-group">${renderGroup(group)}</span>`
          ).join('\n');
        }
      });
    });
    chordsBtns.forEach(btn => {
      const icon = btn.querySelector('.btn-icon');
      const label = btn.querySelector('.btn-label');
      const container = btn.closest('.song-controls-buttons');
      const chordsLabel = container?.getAttribute('data-chords-label') || 'Chords';
      const textLabel = container?.getAttribute('data-text-label') || 'Text';
      if (icon) icon.textContent = showChords ? 'â™ª' : 'T';
      if (label) label.textContent = showChords ? chordsLabel : textLabel;
      btn.setAttribute('title', showChords ? 'Hide chords (show text only)' : 'Show chords');
    });
    updateLayoutToggle();
    updateTransposeDisplay();
  }

  function updateLayoutToggle() {
    layoutToggleBtns.forEach(btn => {
      const icon = btn.querySelector('.btn-icon');
      const label = btn.querySelector('.btn-label');
      const container = btn.closest('.song-controls-buttons');
      const sideLabel = container?.getAttribute('data-layout-side-label') || 'Side';
      const topLabel = container?.getAttribute('data-layout-top-label') || 'Top';
      if (icon) icon.textContent = sideLayout ? 'â«´' : 'â«¶';
      if (label) label.textContent = sideLayout ? topLabel : sideLabel;
      btn.setAttribute('title', sideLayout ? 'Show chords inline' : 'Show chords on the side');
    });
  }

  function saveLayoutPreference() {
    localStorage.setItem(LAYOUT_KEY, String(sideLayout));
  }

  function updateTransposeDisplay() {
    const displayValue = transposeValue === 0 ? '0' : (transposeValue > 0 ? `+${transposeValue}` : `${transposeValue}`);
    transposeValueDisplays.forEach(display => {
      display.textContent = displayValue;
    });
  }

  function saveChordPreference() {
    localStorage.setItem(CHORDS_KEY, String(showChords));
  }

  function saveTranspose() {
    localStorage.setItem(TRANSPOSE_KEY, String(transposeValue));
  }

  function applyColumns() {
    const columns = COLUMNS[currentColumnIndex];
    [contentMobile, contentDesktop].forEach(content => {
      if (content) {
        const preElements = content.querySelectorAll('pre');
        preElements.forEach((el) => {
          (el as HTMLElement).style.columnCount = String(columns);
        });
      }
    });
    columnCountDisplays.forEach(display => {
      display.textContent = String(columns);
    });
  }

  function saveColumns() {
    localStorage.setItem(COLUMNS_KEY, String(currentColumnIndex));
  }

  decreaseBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      if (currentIndex > 0) {
        currentIndex--;
        applyFontSize();
        saveFontSize();
      }
    });
  });

  increaseBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      if (currentIndex < FONT_SIZES.length - 1) {
        currentIndex++;
        applyFontSize();
        saveFontSize();
      }
    });
  });

  lightModeBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      lightMode = !lightMode;
      applyLightMode();
      saveLightMode();
    });
  });

  chordsBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      showChords = !showChords;
      applyChordVisibility();
      saveChordPreference();
    });
  });

  layoutToggleBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      sideLayout = !sideLayout;
      applyChordVisibility();
      saveLayoutPreference();
    });
  });

  columnDecreaseBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      if (currentColumnIndex > 0) {
        currentColumnIndex--;
        applyColumns();
        saveColumns();
      }
    });
  });

  columnIncreaseBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      if (currentColumnIndex < COLUMNS.length - 1) {
        currentColumnIndex++;
        applyColumns();
        saveColumns();
      }
    });
  });

  transposeDownBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      transposeValue--;
      applyChordVisibility();
      saveTranspose();
    });
  });

  transposeUpBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      transposeValue++;
      applyChordVisibility();
      saveTranspose();
    });
  });

  // Autoscroll functions
  function startAutoscroll() {
    if (isAutoscrolling) return;
    isAutoscrolling = true;
    accumulatedScroll = 0;

    function scroll() {
      if (!isAutoscrolling) {
        stopAutoscroll();
        return;
      }

      const speed = SCROLL_SPEEDS[autoscrollSpeedIndex];
      accumulatedScroll += speed;

      // Only scroll when we've accumulated at least 1 pixel
      if (accumulatedScroll >= 1) {
        const pixelsToScroll = Math.floor(accumulatedScroll);
        window.scrollBy(0, pixelsToScroll);
        accumulatedScroll -= pixelsToScroll;
      }

      // Check if we've reached the bottom
      const scrollTop = window.scrollY || document.documentElement.scrollTop;
      const scrollHeight = document.documentElement.scrollHeight;
      const clientHeight = window.innerHeight;

      if (scrollTop + clientHeight >= scrollHeight - 1) {
        stopAutoscroll();
        return;
      }

      autoscrollAnimationId = requestAnimationFrame(scroll);
    }

    autoscrollAnimationId = requestAnimationFrame(scroll);
    updateAutoscrollUI();
  }

  function stopAutoscroll() {
    isAutoscrolling = false;
    accumulatedScroll = 0;
    if (autoscrollAnimationId !== null) {
      cancelAnimationFrame(autoscrollAnimationId);
      autoscrollAnimationId = null;
    }
    updateAutoscrollUI();
  }

  function toggleAutoscroll() {
    if (isAutoscrolling) {
      stopAutoscroll();
    } else {
      startAutoscroll();
    }
  }

  function updateAutoscrollUI() {
    autoscrollToggleBtns.forEach(btn => {
      const icon = btn.querySelector('.btn-icon');
      const label = btn.querySelector('.btn-label');
      const container = btn.closest('.song-controls-buttons');
      const scrollLabel = container?.getAttribute('data-scroll-label') || 'Scroll';
      const pauseLabel = container?.getAttribute('data-scroll-pause-label') || 'Pause';

      if (icon) icon.textContent = isAutoscrolling ? 'â¸\uFE0E' : 'â–¶\uFE0E';
      if (label) label.textContent = isAutoscrolling ? pauseLabel : scrollLabel;
      btn.classList.toggle('active', isAutoscrolling);
    });

    // Update speed display (show 1-5 instead of array index)
    autoscrollSpeedDisplays.forEach(display => {
      display.textContent = String(autoscrollSpeedIndex + 1);
    });
  }

  function saveAutoscrollSpeed() {
    localStorage.setItem(AUTOSCROLL_KEY, String(autoscrollSpeedIndex));
  }

  // Autoscroll event listeners
  autoscrollToggleBtns.forEach(btn => {
    btn.addEventListener('click', toggleAutoscroll);
  });

  autoscrollSlowerBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      if (autoscrollSpeedIndex > 0) {
        autoscrollSpeedIndex--;
        updateAutoscrollUI();
        saveAutoscrollSpeed();
      }
    });
  });

  autoscrollFasterBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      if (autoscrollSpeedIndex < SCROLL_SPEEDS.length - 1) {
        autoscrollSpeedIndex++;
        updateAutoscrollUI();
        saveAutoscrollSpeed();
      }
    });
  });

  // Stop autoscroll on manual scroll
  function handleManualScroll() {
    if (isAutoscrolling) {
      stopAutoscroll();
    }
  }

  window.addEventListener('wheel', handleManualScroll, { passive: true });
  window.addEventListener('touchstart', (e) => {
    // Don't stop autoscroll if touching the autoscroll buttons
    if (e.target instanceof Element &&
        (e.target.closest('.autoscroll-toggle') || e.target.closest('.autoscroll-controls'))) {
      return;
    }
    handleManualScroll();
  }, { passive: true });

  // Pause on tab hidden
  document.addEventListener('visibilitychange', () => {
    if (document.hidden && isAutoscrolling) {
      stopAutoscroll();
    }
  });

  // Stop on window resize (container may change)
  window.addEventListener('resize', () => {
    if (isAutoscrolling) {
      stopAutoscroll();
    }
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    // Don't trigger if typing in an input
    if (e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement) {
      return;
    }

    // Spacebar: toggle autoscroll
    if (e.code === 'Space' && !e.ctrlKey && !e.altKey && !e.metaKey) {
      e.preventDefault();
      toggleAutoscroll();
    }

    // Shift+ArrowUp: increase speed
    if (e.shiftKey && e.code === 'ArrowUp') {
      e.preventDefault();
      if (autoscrollSpeedIndex < SCROLL_SPEEDS.length - 1) {
        autoscrollSpeedIndex++;
        updateAutoscrollUI();
        saveAutoscrollSpeed();
      }
    }

    // Shift+ArrowDown: decrease speed
    if (e.shiftKey && e.code === 'ArrowDown') {
      e.preventDefault();
      if (autoscrollSpeedIndex > 0) {
        autoscrollSpeedIndex--;
        updateAutoscrollUI();
        saveAutoscrollSpeed();
      }
    }
  });

  // Video toggle functions
  function applyVideoVisibility() {
    [contentMobile, contentDesktop].forEach(content => {
      if (content) {
        content.classList.toggle('hide-video', !showVideo);
      }
    });
    videoToggleBtns.forEach(btn => {
      const label = btn.querySelector('.btn-label');
      const container = btn.closest('.song-controls-buttons');
      const videoLabel = container?.getAttribute('data-video-label') || 'Video';
      const videoHideLabel = container?.getAttribute('data-video-hide-label') || 'Hide Video';
      if (label) label.textContent = showVideo ? videoHideLabel : videoLabel;
    });
  }

  function saveVideoPreference() {
    localStorage.setItem(VIDEO_KEY, String(showVideo));
  }

  videoToggleBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      showVideo = !showVideo;
      applyVideoVisibility();
      saveVideoPreference();
    });
  });

  applyFontSize();
  applyLightMode();
  storeOriginalContent();
  applyChordVisibility();
  applyColumns();
  updateAutoscrollUI();
  applyVideoVisibility();
</script>

<style>
  .song-meta {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
    flex-wrap: wrap;
  }

  .song-author {
    color: var(--retro-teal);
    font-size: 1.1rem;
  }

  .song-date {
    color: var(--retro-black);
    font-size: 1rem;
  }
</style>
