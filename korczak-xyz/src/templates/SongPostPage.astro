---
import { getCollection, render } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import PageContent from '../components/PageContent.astro';
import '../styles/song.css';
import { type Lang, useTranslations } from '../i18n';

interface Props {
  lang: Lang;
  slug: string;
}

const { lang, slug } = Astro.props;
const t = useTranslations(lang);

// Songs are only in Polish collection
const songs = await getCollection('songs', ({ data }) =>
  data.published && data.language === 'pl' && data.slug === slug
);

if (songs.length === 0) {
  return Astro.redirect('/404');
}

const song = songs[0];
const { Content } = await render(song);

function formatDate(date: Date, locale: string): string {
  const localeMap: Record<string, string> = {
    'en': 'en-US',
    'pl': 'pl-PL'
  };
  return date.toLocaleDateString(localeMap[locale] || locale);
}
---

<Layout title={`${song.data.title} | korczak.xyz`} lang={lang}>
  <div class="song-page">
    <div class="window song-header-window">
      <div class="song-header-bar">
        <div class="title-bar song-title-bar">
          <span class="song-title-text">{song.data.title}</span>
          <div class="title-buttons">
            <div class="title-btn minimize-btn"></div>
            <div class="title-btn maximize-btn"></div>
            <div class="title-btn close-btn"></div>
          </div>
        </div>
        <div class="song-controls">
          <div class="song-meta">
            <span class="song-author">[{song.data.author}]</span>
            <span class="song-date">{t('Date added')}: {formatDate(song.data.dateAdded, lang)}</span>
          </div>
          <div class="song-controls-buttons">
            <button class="chords-toggle" title="Toggle chords">♪</button>
            <button class="light-mode-toggle" title="Toggle light mode">☀</button>
            <button class="font-decrease" title="Decrease font size">-</button>
            <button class="font-increase" title="Increase font size">+</button>
            <span class="column-controls">
              <button class="column-decrease" title="Fewer columns">◀</button>
              <span class="column-count">1</span>
              <button class="column-increase" title="More columns">▶</button>
            </span>
          </div>
        </div>
      </div>
      <div class="window-content song-content-wrapper">
        <section class="blog_post" id="song-content" itemprop="articleBody">
          <Content />
        </section>
      </div>
    </div>
    <div class="window song-window song-desktop-only">
      <div class="title-bar">
        <span>{song.data.title}</span>
        <div class="title-buttons">
          <div class="title-btn minimize-btn"></div>
          <div class="title-btn maximize-btn"></div>
          <div class="title-btn close-btn"></div>
        </div>
      </div>
      <div class="song-controls song-controls-desktop">
        <div class="song-meta">
          <span class="song-author">[{song.data.author}]</span>
          <span class="song-date">{t('Date added')}: {formatDate(song.data.dateAdded, lang)}</span>
        </div>
        <div class="song-controls-buttons">
          <button class="chords-toggle" title="Toggle chords">♪</button>
          <button class="light-mode-toggle" title="Toggle light mode">☀</button>
          <button class="font-decrease" title="Decrease font size">-</button>
          <button class="font-increase" title="Increase font size">+</button>
          <span class="column-controls">
            <button class="column-decrease" title="Fewer columns">◀</button>
            <span class="column-count">1</span>
            <button class="column-increase" title="More columns">▶</button>
          </span>
        </div>
      </div>
      <div class="window-content song-content-wrapper">
        <section class="blog_post" id="song-content-desktop" itemprop="articleBody">
          <Content />
        </section>
      </div>
    </div>
  </div>
</Layout>

<script>
  const contentMobile = document.getElementById('song-content');
  const contentDesktop = document.getElementById('song-content-desktop');
  const decreaseBtns = document.querySelectorAll('.font-decrease');
  const increaseBtns = document.querySelectorAll('.font-increase');
  const lightModeBtns = document.querySelectorAll('.light-mode-toggle');
  const chordsBtns = document.querySelectorAll('.chords-toggle');
  const columnDecreaseBtns = document.querySelectorAll('.column-decrease');
  const columnIncreaseBtns = document.querySelectorAll('.column-increase');
  const columnCountDisplays = document.querySelectorAll('.column-count');

  const FONT_SIZES = [1.0, 1.2, 1.4, 1.6, 1.8, 2.0, 2.4];
  const COLUMNS = [1, 2, 3, 4];
  const STORAGE_KEY = 'song-font-size-index';
  const LIGHT_MODE_KEY = 'song-light-mode';
  const CHORDS_KEY = 'song-show-chords';
  const COLUMNS_KEY = 'song-columns';

  let currentIndex = parseInt(localStorage.getItem(STORAGE_KEY) || '2', 10);
  let lightMode = localStorage.getItem(LIGHT_MODE_KEY) === 'true';
  let showChords = localStorage.getItem(CHORDS_KEY) !== 'false';
  let currentColumnIndex = parseInt(localStorage.getItem(COLUMNS_KEY) || '0', 10);

  function applyFontSize() {
    [contentMobile, contentDesktop].forEach(content => {
      if (content) {
        const size = FONT_SIZES[currentIndex];
        content.style.fontSize = `${size}rem`;
        const codeElements = content.querySelectorAll('pre code');
        codeElements.forEach((el) => {
          (el as HTMLElement).style.fontSize = `${size}rem`;
        });
      }
    });
  }

  function applyLightMode() {
    [contentMobile, contentDesktop].forEach(content => {
      if (content) {
        content.classList.toggle('light-mode', lightMode);
      }
    });
    lightModeBtns.forEach(btn => {
      btn.textContent = lightMode ? '☾' : '☀';
    });
  }

  function saveFontSize() {
    localStorage.setItem(STORAGE_KEY, String(currentIndex));
  }

  function saveLightMode() {
    localStorage.setItem(LIGHT_MODE_KEY, String(lightMode));
  }

  function isChordLine(line: string): boolean {
    if (line.trim() === '') return false;
    // Chord pattern: optional whitespace, then chord symbols separated by spaces
    // Chords: A-H (or a-h for minor), optionally followed by #/b, then modifiers like m, 7, maj7, sus4, etc.
    const chordPattern = /^[A-Ha-h][#b]?(m|maj|min|dim|aug|sus|add|7|9|11|13|6|4|2)*$/;
    const tokens = line.trim().split(/\s+/);
    // A line is a chord line if all non-empty tokens match the chord pattern
    // and there's at least one token
    if (tokens.length === 0) return false;
    return tokens.every(token => {
      if (token === '') return true;
      // Also match verse numbers like "1." or "Ref." at start of lyrics
      if (/^\d+\.$/.test(token) || /^Ref\.?:?$/.test(token)) return false;
      return chordPattern.test(token);
    });
  }

  // Store original content for each code element
  const originalContent = new Map<Element, string>();

  function storeOriginalContent() {
    [contentMobile, contentDesktop].forEach(content => {
      if (!content) return;
      const codeElements = content.querySelectorAll('pre code');
      codeElements.forEach(codeEl => {
        if (!originalContent.has(codeEl)) {
          originalContent.set(codeEl, codeEl.textContent || '');
        }
      });
    });
  }

  function applyChordVisibility() {
    [contentMobile, contentDesktop].forEach(content => {
      if (!content) return;
      const codeElements = content.querySelectorAll('pre code');
      codeElements.forEach(codeEl => {
        const original = originalContent.get(codeEl);
        if (!original) return;

        if (showChords) {
          // Show all lines
          codeEl.textContent = original;
        } else {
          // Filter out chord lines
          const lines = original.split('\n');
          const filtered = lines.filter(line => !isChordLine(line));
          codeEl.textContent = filtered.join('\n');
        }
      });
    });
    chordsBtns.forEach(btn => {
      btn.textContent = showChords ? '♪' : 'T';
      btn.setAttribute('title', showChords ? 'Hide chords (show text only)' : 'Show chords');
    });
  }

  function saveChordPreference() {
    localStorage.setItem(CHORDS_KEY, String(showChords));
  }

  function applyColumns() {
    const columns = COLUMNS[currentColumnIndex];
    [contentMobile, contentDesktop].forEach(content => {
      if (content) {
        const preElements = content.querySelectorAll('pre');
        preElements.forEach((el) => {
          (el as HTMLElement).style.columnCount = String(columns);
        });
      }
    });
    columnCountDisplays.forEach(display => {
      display.textContent = String(columns);
    });
  }

  function saveColumns() {
    localStorage.setItem(COLUMNS_KEY, String(currentColumnIndex));
  }

  decreaseBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      if (currentIndex > 0) {
        currentIndex--;
        applyFontSize();
        saveFontSize();
      }
    });
  });

  increaseBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      if (currentIndex < FONT_SIZES.length - 1) {
        currentIndex++;
        applyFontSize();
        saveFontSize();
      }
    });
  });

  lightModeBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      lightMode = !lightMode;
      applyLightMode();
      saveLightMode();
    });
  });

  chordsBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      showChords = !showChords;
      applyChordVisibility();
      saveChordPreference();
    });
  });

  columnDecreaseBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      if (currentColumnIndex > 0) {
        currentColumnIndex--;
        applyColumns();
        saveColumns();
      }
    });
  });

  columnIncreaseBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      if (currentColumnIndex < COLUMNS.length - 1) {
        currentColumnIndex++;
        applyColumns();
        saveColumns();
      }
    });
  });

  applyFontSize();
  applyLightMode();
  storeOriginalContent();
  applyChordVisibility();
  applyColumns();
</script>

<style>
  .song-meta {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
    flex-wrap: wrap;
  }

  .song-author {
    color: var(--retro-teal);
    font-size: 1.1rem;
  }

  .song-date {
    color: var(--retro-black);
    font-size: 1rem;
  }
</style>
