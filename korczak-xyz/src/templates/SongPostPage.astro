---
import { getCollection, render } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import PageContent from '../components/PageContent.astro';
import '../styles/song.css';
import { type Lang, useTranslations } from '../i18n';

interface Props {
  lang: Lang;
  slug: string;
}

const { lang, slug } = Astro.props;
const t = useTranslations(lang);

// Songs are only in Polish collection
const songs = await getCollection('songs', ({ data }) =>
  data.published && data.language === 'pl' && data.slug === slug
);

if (songs.length === 0) {
  return Astro.redirect('/404');
}

const song = songs[0];
const { Content } = await render(song);

function formatDate(date: Date, locale: string): string {
  const localeMap: Record<string, string> = {
    'en': 'en-US',
    'pl': 'pl-PL'
  };
  return date.toLocaleDateString(localeMap[locale] || locale);
}
---

<Layout title={`${song.data.title} | korczak.xyz`} lang={lang}>
  <div class="song-page">
    <div class="song-header-window">
      <div class="song-title-bar">
        <span class="song-title-text">{song.data.title}</span>
        <div class="title-buttons">
          <div class="title-btn minimize-btn"></div>
          <div class="title-btn maximize-btn"></div>
          <div class="title-btn close-btn"></div>
        </div>
      </div>
      <div class="song-controls">
        <div class="song-meta">
          <span class="song-author">[{song.data.author}]</span>
          <span class="song-date">{t('Date added')}: {formatDate(song.data.dateAdded, lang)}</span>
        </div>
        <div class="song-controls-buttons">
          <button id="font-decrease" title="Decrease font size">-</button>
          <button id="font-increase" title="Increase font size">+</button>
        </div>
      </div>
    </div>
    <div class="window song-window">
      <div class="window-content song-content-wrapper">
        <h1 class="song-desktop-title">{song.data.title}</h1>
        <div class="song-desktop-meta">
          <span class="song-author">[{song.data.author}]</span>
          <span class="song-date">{t('Date added')}: {formatDate(song.data.dateAdded, lang)}</span>
        </div>
        <section class="blog_post" id="song-content" itemprop="articleBody">
          <Content />
        </section>
      </div>
    </div>
  </div>
</Layout>

<script>
  const content = document.getElementById('song-content');
  const decreaseBtn = document.getElementById('font-decrease');
  const increaseBtn = document.getElementById('font-increase');

  const FONT_SIZES = [1.0, 1.2, 1.4, 1.6, 1.8, 2.0, 2.4];
  const STORAGE_KEY = 'song-font-size-index';

  let currentIndex = parseInt(localStorage.getItem(STORAGE_KEY) || '2', 10);

  function applyFontSize() {
    if (content) {
      const size = FONT_SIZES[currentIndex];
      content.style.fontSize = `${size}rem`;
      const codeElements = content.querySelectorAll('pre code');
      codeElements.forEach((el) => {
        (el as HTMLElement).style.fontSize = `${size}rem`;
      });
    }
  }

  function saveFontSize() {
    localStorage.setItem(STORAGE_KEY, String(currentIndex));
  }

  decreaseBtn?.addEventListener('click', () => {
    if (currentIndex > 0) {
      currentIndex--;
      applyFontSize();
      saveFontSize();
    }
  });

  increaseBtn?.addEventListener('click', () => {
    if (currentIndex < FONT_SIZES.length - 1) {
      currentIndex++;
      applyFontSize();
      saveFontSize();
    }
  });

  applyFontSize();
</script>

<style>
  .song-meta {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
    flex-wrap: wrap;
  }

  .song-author {
    color: var(--retro-teal);
    font-size: 1.1rem;
  }

  .song-date {
    color: var(--retro-dark-gray);
    font-size: 1rem;
  }

  /* Mobile: contrasting colors in the bar */
  @media (max-width: 600px) {
    .song-author {
      color: var(--retro-navy);
      font-weight: bold;
    }

    .song-date {
      color: var(--retro-black);
    }
  }
</style>
