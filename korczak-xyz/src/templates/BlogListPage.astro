---
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import PageContent from '../components/PageContent.astro';
import BlogPageItem from '../components/BlogPageItem.astro';
import { useTranslations, type Lang } from '../i18n';

interface Props {
  lang: Lang;
}

const { lang } = Astro.props;
const t = useTranslations(lang);

// Extract excerpt from MDX body - strip markdown syntax and take first ~160 chars
function extractExcerpt(body: string, maxLength: number = 160): string {
  // Remove MDX imports and components
  let text = body
    .replace(/^import\s+.*$/gm, '')
    .replace(/<[^>]+>/g, '')
    // Remove markdown images
    .replace(/!\[[^\]]*\]\([^)]*\)/g, '')
    // Remove markdown links but keep text
    .replace(/\[([^\]]+)\]\([^)]*\)/g, '$1')
    // Remove headers
    .replace(/^#{1,6}\s+/gm, '')
    // Remove bold/italic
    .replace(/\*\*([^*]+)\*\*/g, '$1')
    .replace(/\*([^*]+)\*/g, '$1')
    .replace(/_([^_]+)_/g, '$1')
    // Remove code blocks
    .replace(/```[\s\S]*?```/g, '')
    .replace(/`([^`]+)`/g, '$1')
    // Remove horizontal rules
    .replace(/^---+$/gm, '')
    // Collapse whitespace
    .replace(/\s+/g, ' ')
    .trim();

  if (text.length <= maxLength) {
    return text;
  }

  // Truncate at word boundary and add ellipsis
  const truncated = text.substring(0, maxLength);
  const lastSpace = truncated.lastIndexOf(' ');
  return truncated.substring(0, lastSpace) + '...';
}

const collectionName = `blog-${lang}` as 'blog-en' | 'blog-pl';
const posts = await getCollection(collectionName, ({ data }) =>
  data.published
);

// Sort by date descending
posts.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

// Add excerpts to posts
const postsWithExcerpts = posts.map(post => ({
  ...post,
  excerpt: extractExcerpt(post.body || '', 160)
}));
---

<Layout title={`${t('Blog')} | korczak.xyz`} lang={lang}>
  <PageContent title={t('Blog')}>
    <ul class="flex flex-col gap-10">
      {postsWithExcerpts.map(post => (
        <BlogPageItem
          slug={post.data.slug}
          title={post.data.title}
          date={post.data.date}
          excerpt={post.excerpt}
          featuredImage={post.data.featuredImage}
          lang={lang}
        />
      ))}
    </ul>
  </PageContent>
</Layout>
