---
import { useTranslations, getAlternateLangPath, type Lang } from '../../i18n';
import { execSync } from 'child_process';

interface Props {
  lang: Lang;
  currentPath: string;
}

const { lang, currentPath } = Astro.props;

// Build-time info (runs at build, not in browser)
const commitHash = execSync('git rev-parse --short HEAD').toString().trim();
const buildTimestamp = new Date().toISOString();
const t = useTranslations(lang);

const navigation = [
  { name: t('Home'), to: lang === 'en' ? '/' : '/pl/', icon: '~' },
  { name: t('About'), to: lang === 'en' ? '/about/' : '/pl/about/', icon: '?' },
  { name: t('Mentoring'), to: lang === 'en' ? '/mentoring/' : '/pl/mentoring/', icon: '@' },
  { name: t('Courses'), to: lang === 'en' ? '/courses/' : '/pl/courses/', icon: '</>' },
  { name: t('Blog'), to: lang === 'en' ? '/blog/' : '/pl/blog/', icon: '#' },
  { name: t('Songs'), to: lang === 'en' ? '/songs/' : '/pl/songs/', icon: '*' },
  { name: t('Games'), to: lang === 'en' ? '/games/' : '/pl/games/', icon: 'â™ ' },
];

// Get alternate language path for language switcher
const enPath = lang === 'en' ? currentPath : getAlternateLangPath(currentPath, lang, 'en');
const plPath = lang === 'pl' ? currentPath : getAlternateLangPath(currentPath, lang, 'pl');

// Check if a nav item is active (current page)
function isActive(itemPath: string): boolean {
  // Exact match for home page
  if (itemPath === '/' || itemPath === '/pl/') {
    return currentPath === itemPath;
  }
  // For other pages, check if currentPath starts with the item path
  return currentPath.startsWith(itemPath);
}
---

<div class="window navbar-window">
  <div class="title-bar">
    <span class="site-title">korczak.xyz - Navigator</span>
    <div class="title-buttons">
      <div class="title-btn minimize-btn"></div>
      <div class="title-btn maximize-btn"></div>
      <div class="title-btn close-btn"></div>
    </div>
  </div>

  <div class="navbar-content">
    <!-- Mobile menu button -->
    <button class="menu-btn" id="menu-button" aria-label="Menu">
      [MENU]
    </button>

    <!-- Navigation links -->
    <nav id="main-nav" class="nav-links">
      {navigation.map(item => (
        <a href={item.to} class={`nav-link ${isActive(item.to) ? 'active' : ''}`}>
          <span class="nav-icon">{item.icon}</span>
          <span class="nav-text">{item.name}</span>
        </a>
      ))}

      <!-- Language switcher -->
      <div class="lang-switcher">
        <a href={enPath} class={`lang-btn ${lang === 'en' ? 'active' : ''}`}>EN</a>
        <span class="lang-divider">|</span>
        <a href={plPath} class={`lang-btn ${lang === 'pl' ? 'active' : ''}`}>PL</a>
      </div>
    </nav>

  </div>

  <!-- Status bar (Windows 95 style) -->
  <div class="status-bar">
    <div class="status-panel">
      <a href={`https://github.com/oskarissimus/korczak-xyz/commit/${commitHash}`} target="_blank" rel="noopener">{commitHash}</a>
    </div>
    <div class="status-panel">
      {t('statusBar.lastUpdated')} <span id="navbar-build-time" data-timestamp={buildTimestamp}>{buildTimestamp}</span>
    </div>
  </div>
</div>

<style>
  .navbar-window {
    margin-bottom: 20px;
  }

  .site-title {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .navbar-content {
    background: var(--retro-gray);
    padding: 6px 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
  }

  .menu-btn {
    display: none;
    background: var(--retro-gray);
    border: 2px outset var(--retro-white);
    padding: 5px 10px;
    font-family: 'VT323', monospace;
    font-size: 1rem;
    cursor: pointer;
    color: var(--retro-black);
  }

  .menu-btn:active {
    border-style: inset;
  }

  .nav-links {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    align-items: center;
    width: 100%;
  }

  .nav-link {
    background: var(--retro-gray);
    border: 2px outset var(--retro-white);
    padding: 6px 12px;
    text-decoration: none;
    color: var(--retro-black);
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 5px;
    transition: none;
  }

  .nav-link:hover {
    background: #a0a0a0;
    color: var(--retro-black);
  }

  .nav-link:active,
  .nav-link.active {
    border-style: inset;
    background: #a0a0a0;
  }

  .nav-icon {
    color: var(--retro-navy);
    font-weight: bold;
  }

  .nav-text {
    color: var(--retro-black);
  }

  .lang-switcher {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 5px;
    background: var(--retro-teal);
    padding: 5px 10px;
    border: 2px inset var(--retro-dark-gray);
  }

  .lang-btn {
    color: var(--retro-yellow);
    text-decoration: none;
    font-weight: bold;
    padding: 2px 5px;
  }

  .lang-btn:hover {
    color: var(--retro-white);
  }

  .lang-btn.active {
    background: var(--retro-navy);
    color: var(--retro-white);
  }

  .lang-divider {
    color: var(--retro-yellow);
  }

  .status-bar {
    display: flex;
    background: var(--retro-gray);
    padding: 2px;
    gap: 2px;
  }

  .status-panel {
    background: var(--retro-gray);
    border: 2px solid;
    border-color: var(--retro-dark-gray) var(--retro-white) var(--retro-white) var(--retro-dark-gray);
    padding: 1px 4px;
    font-size: 0.8rem;
    color: var(--retro-black);
  }

  .status-panel:first-child {
    flex: 0 0 auto;
  }

  .status-panel:last-child {
    flex: 1;
  }

  .status-panel a {
    color: var(--retro-black);
    text-decoration: none;
  }

  .status-panel a:hover {
    text-decoration: underline;
  }

  /* Mobile styles */
  @media (max-width: 768px) {
    .menu-btn {
      display: block;
    }

    .nav-links {
      display: none;
      flex-direction: column;
      align-items: stretch;
      width: 100%;
      margin-top: 10px;
    }

    .nav-links.show {
      display: flex;
    }

    .nav-link {
      justify-content: flex-start;
    }

    .lang-switcher {
      margin-left: 0;
      justify-content: center;
    }
  }
</style>

<script>
  const menuButton = document.getElementById('menu-button');
  const mainNav = document.getElementById('main-nav');

  menuButton?.addEventListener('click', () => {
    mainNav?.classList.toggle('show');
  });

  // Format build timestamp based on locale
  const buildTimeEl = document.getElementById('navbar-build-time');
  if (buildTimeEl) {
    const timestamp = buildTimeEl.dataset.timestamp;
    if (timestamp) {
      const date = new Date(timestamp);
      const lang = document.documentElement.lang || 'en';
      const locale = lang === 'pl' ? 'pl-PL' : 'en-US';
      buildTimeEl.textContent = date.toLocaleString(locale, {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
      });
    }
  }
</script>
